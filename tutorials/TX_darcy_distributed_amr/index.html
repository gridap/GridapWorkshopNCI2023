<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <script src="/GridapWorkshopNCI2023/libs/lunr/lunr.min.js"></script> <script src="/GridapWorkshopNCI2023/libs/lunr/lunr_index.js"></script> <script src="/GridapWorkshopNCI2023/libs/lunr/lunrclient.min.js"></script> <link rel=stylesheet  href="/GridapWorkshopNCI2023/libs/katex/katex.min.css"> <link rel=stylesheet  href="/GridapWorkshopNCI2023/libs/highlight/github.min.css"> <link rel=stylesheet  href="/GridapWorkshopNCI2023/css/franklin.css"> <link rel=stylesheet  href="/GridapWorkshopNCI2023/css/poole_hyde.css"> <link rel=stylesheet  href="/GridapWorkshopNCI2023/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=apple-touch-icon  sizes=152x152  href="/GridapWorkshopNCI2023/assets/favicon/apple-touch-icon.png"> <link rel=icon  type="image/png" sizes=32x32  href="/GridapWorkshopNCI2023/assets/favicon/favicon-32x32.png"> <link rel=icon  type="image/png" sizes=16x16  href="/GridapWorkshopNCI2023/assets/favicon/favicon-16x16.png"> <link rel=manifest  href="/GridapWorkshopNCI2023/assets/favicon/site.webmanifest"> <link rel=mask-icon  href="/GridapWorkshopNCI2023/assets/favicon/safari-pinned-tab.svg" color="#5bbad5"> <meta name=msapplication-TileColor  content="#da532c"> <meta name=theme-color  content="#ffffff"> <title>Darcy + Distributed AMR</title> <style> .content {max-width: 60rem} </style> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <img src="/GridapWorkshopNCI2023/assets/logos.png" style="width: 500px; height: auto; display: inline"> <div style="font-weight: margin-bottom: 0.5em"><a href="/GridapWorkshopNCI2023/">28-29th, November, 2023</a> <span style="opacity: 0.9;">| Australian National University, Canberra</span></div> <br> <h1><a href="/GridapWorkshopNCI2023/">Introduction to Gridap: Simulating PDEs using finite elements in Julia</a></h1> <div style="line-height:18px; font-size: 15px; opacity: 0.85">by &nbsp; <a href="https://research.monash.edu/en/persons/santiago-badia">Santiago Badia</a>, &nbsp; <a href="https://amartinhuertas.github.io/">Alberto F. Martin</a>, &nbsp; <a href="https://github.com/JordiManyer">Jordi Manyer</a> </div> </div> <br> <style> </style> <nav class=sidebar-nav  style="opacity: 0.9; margin-bottom: 1.2cm;"> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/"><b>Welcome</b></a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/venue/"><b>Venue</b></a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/schedule"><b>Schedule</b></a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/software_install/">Software install instructions</a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/tutorials/">Tutorials & Exercises</a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/references/">References</a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/grants/">Registration and grants for research students</a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/acks/">Acknowledgements</a> <a class="sidebar-nav-item " href="/GridapWorkshopNCI2023/flyer/">Event Flyer</a> <br> </nav> <form id=lunrSearchForm  name=lunrSearchForm > <input class=search-input  name=q  placeholder="Enter search term" type=text > <input type=submit  value=Search  formaction="/GridapWorkshopNCI2023/search/index.html"> </form> <br> <br> </div> </div> <div class="content container"> <div class=franklin-content > <h1 id=darcy_flow_parallel_adaptive_mesh_refinement_amr ><a href="#darcy_flow_parallel_adaptive_mesh_refinement_amr" class=header-anchor >Darcy flow &#43; Parallel Adaptive Mesh Refinement &#40;AMR&#41;</a></h1> <p>The purpose of this tutorial is two-fold:</p> <ul> <li><p>To illustrate how to solve a system of PDEs where one of the unknowns lives in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy=false >(</mo><mrow><mi mathvariant=normal >d</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >v</mi></mrow><mo separator=true >;</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">H({\rm div};\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span></span><span class=mpunct >;</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span> &#40;as opposed to <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>H</mi><mn>1</mn></msup><mo stretchy=false >(</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">H^1(\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span>&#41;, thus requiring the construction of a div-conforming finite element space &#40;as opposed to a grad-conforming finite element space&#41;.</p> <li><p>To showcase the <em>dynamic</em> Adaptive Mesh Refinement &#40;AMR&#41; parallel distributed-memory capabilities provided by <code>GridapP4est.jl</code>. To this end, we will solve a system of PDEs featuring a multi-scale solution where the use of these techniques is particularly beneficial from a computational point of view.</p> </ul> <h2 id=problem_statement_strong_form ><a href="#problem_statement_strong_form" class=header-anchor >Problem statement &#40;strong form&#41;</a></h2> <p>We consider as a model problem the so-called Darcy equations, which can be used as a physical model of fluid flow in porous media. The PDE problem reads: find the fluid velocity <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">u</span></span></span></span>, and the fluid pressure <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> such that:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mo fence=true >{</mo><mtable rowspacing=0.24999999999999992em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msup><mi mathvariant=normal >K</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>u</mi><mo>+</mo><mi mathvariant=normal >∇</mi><mi>p</mi><mo>=</mo><mn mathvariant=bold >0</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mtext> in </mtext><mi mathvariant=normal >Ω</mi><mo separator=true >,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi mathvariant=normal >∇</mi><mo>⋅</mo><mi>u</mi><mo>=</mo><mi>f</mi><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mtext> in </mtext><mi mathvariant=normal >Ω</mi><mo separator=true >,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>p</mi><mo>=</mo><mi>g</mi><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mtext> on </mtext><msub><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >N</mi></msub><mo separator=true >,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>u</mi><mo>⋅</mo><mi>n</mi><mo>=</mo><mi>h</mi><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mtext> on </mtext><msub><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >D</mi></msub><mo separator=true >,</mo></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex"> \left\lbrace \begin{aligned} \Kappa^{-1} u + \nabla p = {\bf 0} \ &amp;\text{ in } \ \Omega,\\ \nabla \cdot u = f \ &amp;\text{ in } \ \Omega,\\ p = g \ &amp;\text{ on }\ \Gamma_{\rm N},\\ u \cdot n = h \ &amp;\text{ on }\ \Gamma_{\rm D},\\ \end{aligned} \right. </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:6.024108em;vertical-align:-2.7620539999999996em;"></span><span class=minner ><span class=mopen ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.2500200000000006em;"><span style="top:-1.2999899999999998em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.2949899999999999em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.58999em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.8849900000000002em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.17999em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.2049900000000004em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.1500100000000004em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.29501em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.59001em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.885010000000001em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-5.180010000000001em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-5.205010000000001em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-5.50002em;"><span class=pstrut  style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.75002em;"><span></span></span></span></span></span></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.262054em;"><span style="top:-5.397946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord mathrm">K</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >∇</span><span class="mord mathnormal">p</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class=mord ><span class="mord mathbf">0</span></span></span><span class=mspace > </span></span></span><span style="top:-3.897946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >∇</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mspace > </span></span></span><span style="top:-2.397946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class=mspace > </span></span></span><span style="top:-0.8979460000000006em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">n</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">h</span><span class=mspace > </span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.7620539999999996em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.262054em;"><span style="top:-5.397946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class="mord text"><span class=mord > in </span></span><span class=mspace > </span><span class=mord >Ω</span><span class=mpunct >,</span></span></span><span style="top:-3.897946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class="mord text"><span class=mord > in </span></span><span class=mspace > </span><span class=mord >Ω</span><span class=mpunct >,</span></span></span><span style="top:-2.397946em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class="mord text"><span class=mord > on </span></span><span class=mspace > </span><span class=mord ><span class=mord >Γ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">N</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span></span></span><span style="top:-0.8979460000000006em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class="mord text"><span class=mord > on </span></span><span class=mspace > </span><span class=mord ><span class=mord >Γ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">D</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.7620539999999996em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>with <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> being the outwards unit normal vector to the boundary <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∂</mi><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\partial\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class=mord  style="margin-right:0.05556em;">∂</span><span class=mord >Ω</span></span></span></span>, and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >K</mi></mrow><annotation encoding="application/x-tex">\Kappa</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord ><span class="mord mathrm">K</span></span></span></span></span> the so-called hydraulic conductivity tensor. The first equation is known as Darcy’s law and was formulated by Henry Darcy in 1856; the second equation is the mass conservation equation.</p> <p>In this particular tutorial, for simplicity, we consider the unit square <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi><mo>≐</mo><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><msup><mo stretchy=false >)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\Omega \doteq (0,1)^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≐</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> as the computational domain. Besides, we consider pure Neumann boundary conditions, that is, the Neumann boundary <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >N</mi></msub></mrow><annotation encoding="application/x-tex">\Gamma_{\rm N}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord >Γ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">N</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the full boundary of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>, and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >D</mi></msub></mrow><annotation encoding="application/x-tex">\Gamma_{\rm D}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord >Γ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">D</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the empty set &#40;i.e., no Dirichlet boundary condition&#41;. Finally, we consider the hydraulic conductivity tensor <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >K</mi></mrow><annotation encoding="application/x-tex">\Kappa</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord ><span class="mord mathrm">K</span></span></span></span></span> to be just the identity tensor. In any case, we stress that the general version of the equations stated above are also supported by Gridap.</p> <p>The source term <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> in the mass conservation equation and the Neumann data <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span> are chosen such that the exact &#40;manufactured&#41; fluid pressure is:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub><mo stretchy=false >(</mo><mi mathvariant=bold-italic >x</mi><mo stretchy=false >)</mo><mo>:</mo><mo>=</mo><mrow><mi mathvariant=normal >a</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >n</mi></mrow><mo stretchy=false >(</mo><mi>γ</mi><mo stretchy=false >(</mo><msqrt><mrow><mo stretchy=false >(</mo><mi mathvariant=bold-italic >x</mi><mo>−</mo><msub><mi mathvariant=bold-italic >x</mi><mi>c</mi></msub><mo stretchy=false >)</mo><mo>⋅</mo><mo stretchy=false >(</mo><mi mathvariant=bold-italic >x</mi><mo>−</mo><msub><mi mathvariant=bold-italic >x</mi><mi>c</mi></msub><mo stretchy=false >)</mo></mrow></msqrt><mo>−</mo><mi>r</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mi mathvariant=normal >.</mi></mrow><annotation encoding="application/x-tex"> p_{\rm exact}(\boldsymbol{x}) := \mathrm{arctan}(\gamma(\sqrt{(\boldsymbol{x}-\boldsymbol{x}_c)\cdot(\boldsymbol{x}-\boldsymbol{x}_c)}-r)). </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span></span><span class=base ><span class=strut  style="height:0.36687em;vertical-align:0em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.24em;vertical-align:-0.25612499999999994em;"></span><span class=mord ><span class="mord mathrm">a</span><span class="mord mathrm">r</span><span class="mord mathrm">c</span><span class="mord mathrm">t</span><span class="mord mathrm">a</span><span class="mord mathrm">n</span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class=mopen >(</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.983875em;"><span class=svg-align  style="top:-3.2em;"><span class=pstrut  style="height:3.2em;"></span><span class=mord  style="padding-left:1em;"><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-2.9438750000000002em;"><span class=pstrut  style="height:3.2em;"></span><span class=hide-tail  style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119 c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120 c340,-704.7,510.7,-1060.3,512,-1067 l0 -0 c4.7,-7.3,11,-11,19,-11 H40000v40H1012.3 s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232 c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1 s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26 c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z M1001 80h400000v40h-400000z'/></svg></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.25612499999999994em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mclose >)</span><span class=mclose >)</span><span class=mord >.</span></span></span></span></span> <p>Besides, using Darcy&#39;s law &#40;i.e., first equation of the system above&#41;, we manufacture <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub><mo>=</mo><mo>−</mo><mi mathvariant=normal >K</mi><mi mathvariant=normal >∇</mi><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">u_{\rm exact}=-\Kappa \nabla p_{\rm exact}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class=mord >−</span><span class=mord ><span class="mord mathrm">K</span></span><span class=mord >∇</span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p> <p>The solution <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub><mo stretchy=false >(</mo><mi mathvariant=bold-italic >x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p_{\rm exact}(\boldsymbol{x})</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=mclose >)</span></span></span></span> has a sharp circular/spherical wave front of radius <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> centered at <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=bold-italic >x</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{x}_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.59444em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. For example, for the combination of parameter values <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>=</mo><mn>200</mn></mrow><annotation encoding="application/x-tex">\gamma=200</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >2</span><span class=mord >0</span><span class=mord >0</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>0.7</mn></mrow><annotation encoding="application/x-tex">r=0.7</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >7</span></span></span></span>, and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=bold-italic >x</mi><mi>c</mi></msub><mo>=</mo><mo stretchy=false >(</mo><mo>−</mo><mn>0.05</mn><mo separator=true >,</mo><mo>−</mo><mn>0.05</mn><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\boldsymbol{x}_c=(-0.05, -0.05)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.59444em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >0</span><span class=mord >.</span><span class=mord >0</span><span class=mord >5</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >−</span><span class=mord >0</span><span class=mord >.</span><span class=mord >0</span><span class=mord >5</span><span class=mclose >)</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub><mo stretchy=false >(</mo><mi mathvariant=bold-italic >x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">p_{\rm exact}(\boldsymbol{x})</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol">x</span></span></span><span class=mclose >)</span></span></span></span> looks as in the picture below: <img src="/GridapWorkshopNCI2023/assets/literate_figures/darcy_amr/circular_sharp_wave_2d.png" alt="" /> As consequence of the multi-scale features of this solution, uniform mesh refinement techniques can only reduce the error at a very slow pace with increasing mesh resolution, and thus are very computationally inefficient.</p> <h2 id=problem_statement_weak_form ><a href="#problem_statement_weak_form" class=header-anchor >Problem statement &#40;weak form&#41;</a></h2> <p>We denote by <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy=false >(</mo><mrow><mi mathvariant=normal >d</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >v</mi></mrow><mo separator=true >;</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">H(\mathrm{div};\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class=mord ><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class=mpunct >;</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span> the space of vector-valued fields in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>, whose components and divergence are in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mn>2</mn></msup><mo stretchy=false >(</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">L^2(\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">L</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span>. With these notation, the weak form reads of our problem: find <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mi>u</mi><mo separator=true >,</mo><mi>p</mi><mo stretchy=false >)</mo><mo>∈</mo><mi>H</mi><mo stretchy=false >(</mo><mrow><mi mathvariant=normal >d</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >v</mi></mrow><mo separator=true >;</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo><mo>×</mo><msup><mi>L</mi><mn>2</mn></msup><mo stretchy=false >(</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(u,p)\in H(\mathrm{div};\Omega)\times L^2(\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal">u</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class=mord ><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class=mpunct >;</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >Ω</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">L</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span> such that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo stretchy=false >(</mo><mo stretchy=false >(</mo><mi>u</mi><mo separator=true >,</mo><mi>p</mi><mo stretchy=false >)</mo><mo separator=true >,</mo><mo stretchy=false >(</mo><mi>v</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo>=</mo><mi>b</mi><mo stretchy=false >(</mo><mi>v</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">a((u,p),(v,q)) = b(v,q)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class=mopen >(</span><span class=mopen >(</span><span class="mord mathnormal">u</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class=mclose >)</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span></span></span></span> for all <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mi>v</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo><mo>∈</mo><mi>H</mi><mo stretchy=false >(</mo><mrow><mi mathvariant=normal >d</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >v</mi></mrow><mo separator=true >;</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo><mo>×</mo><msup><mi>L</mi><mn>2</mn></msup><mo stretchy=false >(</mo><mi mathvariant=normal >Ω</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(v,q)\in H(\mathrm{div};\Omega)\times L^2(\Omega)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mopen >(</span><span class=mord ><span class="mord mathrm">d</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class=mpunct >;</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >Ω</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal">L</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >Ω</span><span class=mclose >)</span></span></span></span>, where</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.24999999999999992em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>a</mi><mo stretchy=false >(</mo><mo stretchy=false >(</mo><mi>u</mi><mo separator=true >,</mo><mi>p</mi><mo stretchy=false >)</mo><mo separator=true >,</mo><mo stretchy=false >(</mo><mi>v</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≐</mo><msub><mo>∫</mo><mi mathvariant=normal >Ω</mi></msub><mi>v</mi><mo>⋅</mo><mi>u</mi><mtext> </mtext><mi mathvariant=normal >d</mi><mi mathvariant=normal >Ω</mi><mo>−</mo><msub><mo>∫</mo><mi mathvariant=normal >Ω</mi></msub><mo stretchy=false >(</mo><mi mathvariant=normal >∇</mi><mo>⋅</mo><mi>v</mi><mo stretchy=false >)</mo><mtext> </mtext><mi>p</mi><mtext> </mtext><mi mathvariant=normal >d</mi><mi mathvariant=normal >Ω</mi><mo>+</mo><msub><mo>∫</mo><mi mathvariant=normal >Ω</mi></msub><mi>q</mi><mtext> </mtext><mo stretchy=false >(</mo><mi mathvariant=normal >∇</mi><mo>⋅</mo><mi>u</mi><mo stretchy=false >)</mo><mtext> </mtext><mi mathvariant=normal >d</mi><mi mathvariant=normal >Ω</mi><mo separator=true >,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>b</mi><mo stretchy=false >(</mo><mi>v</mi><mo separator=true >,</mo><mi>q</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≐</mo><msub><mo>∫</mo><mi mathvariant=normal >Ω</mi></msub><mi>q</mi><mtext> </mtext><mi>f</mi><mtext> </mtext><mi mathvariant=normal >d</mi><mi mathvariant=normal >Ω</mi><mo>−</mo><msub><mo>∫</mo><msub><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >N</mi></msub></msub><mo stretchy=false >(</mo><mi>v</mi><mo>⋅</mo><mi>n</mi><mo stretchy=false >)</mo><mtext> </mtext><mi>g</mi><mtext> </mtext><mi mathvariant=normal >d</mi><mi mathvariant=normal >Γ</mi><mi mathvariant=normal >.</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} a((u,p),(v,q)) &amp;\doteq \int_{\Omega} v \cdot u \ {\rm d}\Omega - \int_{\Omega} (\nabla \cdot v)\ p \ {\rm d}\Omega + \int_{\Omega} q\ (\nabla \cdot u) \ {\rm d}\Omega,\\ b(v,q) &amp;\doteq \int_{\Omega} q\ f \ {\rm d}\Omega - \int_{\Gamma_{\rm N}} (v\cdot n)\ g \ {\rm d}\Gamma. \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:5.244205000000001em;vertical-align:-2.3721025000000004em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.8721025000000004em;"><span style="top:-4.8721025000000004em;"><span class=pstrut  style="height:3.3600000000000003em;"></span><span class=mord ><span class="mord mathnormal">a</span><span class=mopen >(</span><span class=mopen >(</span><span class="mord mathnormal">u</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class=mclose >)</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span><span class=mclose >)</span></span></span><span style="top:-2.3001525em;"><span class=pstrut  style="height:3.3600000000000003em;"></span><span class=mord ><span class="mord mathnormal">b</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.3721025000000004em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.8721025000000004em;"><span style="top:-4.8721025000000004em;"><span class=pstrut  style="height:3.3600000000000003em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≐</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mop ><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-0.433619em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Ω</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">u</span><span class=mspace > </span><span class=mord ><span class=mord ><span class="mord mathrm">d</span></span></span><span class=mord >Ω</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mop ><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-0.433619em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Ω</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >∇</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mclose >)</span><span class=mspace > </span><span class="mord mathnormal">p</span><span class=mspace > </span><span class=mord ><span class=mord ><span class="mord mathrm">d</span></span></span><span class=mord >Ω</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mop ><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-0.433619em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Ω</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mspace > </span><span class=mopen >(</span><span class=mord >∇</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">u</span><span class=mclose >)</span><span class=mspace > </span><span class=mord ><span class=mord ><span class="mord mathrm">d</span></span></span><span class=mord >Ω</span><span class=mpunct >,</span></span></span><span style="top:-2.3001525em;"><span class=pstrut  style="height:3.3600000000000003em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≐</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mop ><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-0.433619em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Ω</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mspace > </span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mspace > </span><span class=mord ><span class=mord ><span class="mord mathrm">d</span></span></span><span class=mord >Ω</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mop ><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:-0.433619em;"><span style="top:-1.7880500000000004em;margin-left:-0.44445em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">Γ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:0em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">N</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.012255em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">n</span><span class=mclose >)</span><span class=mspace > </span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class=mspace > </span><span class=mord ><span class=mord ><span class="mord mathrm">d</span></span></span><span class=mord >Γ</span><span class=mord >.</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.3721025000000004em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>This weak form was obtained from the strong form as usual, i.e., multiplication by suitable test functions, and integration by parts in order to transfer derivatives from trial to test functions to reduce the regularity constraints on the weak solution.</p> <h2>Numerical scheme</h2> <p>In this tutorial, we use the div-conforming Raviart-Thomas &#40;RT&#41; space of polynomial order <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\geq0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83041em;vertical-align:-0.13597em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≥</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span></span></span></span> for the fluid velocity approximation, and a discontinuous space of cell-wise polynomials of order <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> in each spatial dimension &#40;denoted as <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">Q_k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal">Q</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>&#41; for the fluid pressure approximation &#40;see &#91;1&#93; for specific details&#41;. This pair of finite element spaces form a so-called <em>discrete inf-sup stable pair</em>. This mathematical property guarantees that the discrete problem is <em>well-posed</em>, i.e., it has a unique solution.</p> <h2 id=adaptive_mesh_refinement_amr_with_forest-of-trees ><a href="#adaptive_mesh_refinement_amr_with_forest-of-trees" class=header-anchor >Adaptive Mesh Refinement &#40;AMR&#41; with forest-of-trees</a></h2> <p>In this tutorial we leverage a more clever/efficient domain discretization approach provided by <a href="https://github.com/gridap/GridapP4est.jl"><code>GridapP4est.jl</code></a>. In particular, we will used a particular Gridap&#39;s <code>DiscreteModel</code> that efficiently supports <em>dynamic</em> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>-adaptivity techniques &#40;a.k.a. AMR&#41;, i.e., the ability of the mesh to be refined <em>in the course of the simulation</em> in those regions of the domain that present a complex behaviour &#40;e.g., the internal layer in the case of our problem at hand&#41;, and to be coarsened in those areas where essentially nothing relevant happens &#40;e.g., those areas away from the internal layer&#41;.</p> <p>In order to support AMR techniques, <code>GridapP4est.jl</code> relies on the so-called forest-of-trees approach for efficient mesh generation and adaptation as provided by the <code>p4est</code> library &#91;2&#93;. Forest-of-trees can be seen as a two-level decomposition of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>, referred to as macro and micro level, resp. In the macro level, we have the so-called coarse mesh, i.e., a <em>conforming</em> partition <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >C</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>. For efficiency reasons, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >C</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> should be as coarse as possible, but it should also keep the geometrical discretization error within tolerable margins. For complex domains, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >C</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is usually generated by an unstructured mesh generator, and then imported into the program using, e.g., using <code>GridapGmsh</code>. For simple domains, such as boxes, a single coarse cell is sufficient to resolve the geometry of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>. On the other hand, in the micro level, each of the cells of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >C</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> becomes the root of an adaptive tree that can be subdivided arbitrarily &#40;i.e., recursively refined&#41; into finer cells.</p> <p>In the case of quadrilateral &#40;2D&#41; or hexahedral &#40;3D&#41; adaptive meshes, the recursive application of the standard isotropic 1:4 &#40;2D&#41; and 1:8 &#40;3D&#41; refinement rule to the coarse mesh cells &#40;i.e., to the adaptive tree roots&#41; leads to adaptive trees that are referred to as quadtrees and octrees, resp., and the data structure resulting from patching them together is called <em>forest-of-quadtrees</em> and <em>-octrees</em>, resp., although the latter term is typically employed in either case. The figure below shows a forest-of-quadtrees mesh with two quadtrees &#40;i.e., <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∣</mi><msub><mi mathvariant=script >C</mi><mi>h</mi></msub><mi mathvariant=normal >∣</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">|\mathcal{C}_h|=2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >∣</span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >2</span></span></span></span>&#41;:</p> <p><img src="/GridapWorkshopNCI2023/assets/literate_figures/darcy_amr/forest_of_trees_partition.png" alt="" /></p> <p>Tree-based meshes provide multi-resolution capability by local adaptation. The cells in the mesh &#40;i.e., the leaves of the adaptive trees&#41; might be located at different refinement level. However, these meshes are &#40;potentially&#41; <em>non-conforming</em>, i.e., they contain the so-called <em>hanging</em> vertices, edges, and faces. These occur at the interface of neighboring cells with different refinement levels. Mesh non-conformity introduces additional complexity in the implementation of conforming finite element formulations &#91;3&#93;. Despite the aforementioned, we note the following. First, the degree of implementation complexity is significantly reduced by enforcing the so-called <em>2:1 balance</em> constraint, i.e., adjacent cells may differ at most by a single level of refinement; the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>-adaptive triangulation in <code>GridapP4est.jl</code> always satisfies this constraint. Second, <code>Gridap</code> is written such that it is entirely responsible for handling such complexity. As demonstrated in this tutorial, library users are not aware of mesh non-conformity when coding the weak form of the finite element formulation at hand.</p> <h2 id=parallelization ><a href="#parallelization" class=header-anchor >Parallelization</a></h2> <p>It order to scale finite element simulations to large core counts, the adaptive mesh must be partitioned &#40;distributed&#41; among the parallel tasks such that each of these only holds a local portion of the global mesh. &#40;The same requirement applies to the rest of data structures in the finite element simulation pipeline, i.e., finite element space, linear system, solver, etc.&#41; Besides, as the solution might exhibit highly localized features, dynamic mesh adaptation can result in an unacceptable amount of load imbalance. Thus, it urges that the adaptive mesh data structure supports <em>dynamic load-balancing</em>, i.e., that it can be re-distributed among the parallel processes in the course of the simulation.</p> <p>Modern forest-of-trees manipulation engines, such as <code>p4est</code>, provide a scalable, linear runtime solution to the mesh &#40;re-&#41;partitioning problem based on the exploitation of Space-Filling-Curves &#40;SFCs&#41;. SFCs provide a natural means to assign an ordering of the forest-of-trees leaves, which is exploited for the parallel arrangement of data. For example, in <code>GridapP4est.jl</code>, the forest-of-octrees leaves are arranged in a global one-dimensional data array in increasing Morton index ordering. This ordering corresponds geometrically with the traversal of a <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>-shaped SFC &#40;a.k.a. Morton SFC&#41;. This approach allows for <em>fast dynamic repartitioning</em>. A partition of the mesh is simply generated by dividing the leaves in the linear ordering induced by the SFCs into as many equally-sized segments as parallel tasks involved in the computation.</p> <p>As an illustration, the figure below shows a 2:1 balanced forest-of-quadtrees mesh with two quadtrees &#40;i.e., <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∣</mi><msub><mi mathvariant=script >C</mi><mi>h</mi></msub><mi mathvariant=normal >∣</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">|\mathcal{C}_h|=2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >∣</span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >2</span></span></span></span>&#41; distributed among two processors, 1:4 refinement and the Morton SFC. Local cells are depicted with continuous boundary lines, while those in the ghost layer with dashed ones.</p> <p><img src="/GridapWorkshopNCI2023/assets/literate_figures/darcy_amr/forest_of_trees.png" alt="" /></p> <p><code>GridapP4est.jl</code> reconstructs the local portion of the mesh corresponding to each parallel task from the distributed forest-of-octrees that the <code>p4est</code> library handles internally. These local portions are illustrated in the figure above when the forest-of-octrees is distributed among two processors. The local portion of each task is composed by a set of cells that it owns, i.e., the <em>local cells</em> of the task, and a set of off-processor cells &#40;owned by remote processors&#41; which are in touch with its local cells, i.e., the <em>ghost cells</em> of the task. This overlapped mesh partition is used by the library to exchange data among nearest neighbours, and to glue together the global degrees-of-freedom of the finite element space which are sitting on the interface among subdomains, as required in order to construct finite element spaces for conforming finite element formulations in a distributed setting.</p> <h2 id=the_commented_code ><a href="#the_commented_code" class=header-anchor >The commented code</a></h2> <p>We first start as usual by importing the packages we will need:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Gridap
<span class=hljs-keyword >using</span> PartitionedArrays
<span class=hljs-keyword >using</span> GridapDistributed
<span class=hljs-keyword >using</span> GridapP4est
<span class=hljs-keyword >using</span> MPI</code></pre> <p>Then we define the manufactured data for our problem, i.e., <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{\rm exact}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">u_{\rm exact}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and the right hand side <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> of the mass conservation equation:</p> <pre><code class="julia hljs">γ, r, xc = <span class=hljs-number >100.0</span>, <span class=hljs-number >0.7</span>, VectorValue(-<span class=hljs-number >0.05</span>, -<span class=hljs-number >0.05</span>)
p_exact(x) = atan(γ * (sqrt((x[<span class=hljs-number >1</span>] - xc[<span class=hljs-number >1</span>])^<span class=hljs-number >2</span> + (x[<span class=hljs-number >2</span>] - xc[<span class=hljs-number >2</span>])^<span class=hljs-number >2</span>) - r))
u_exact(x) = -∇(p_exact)(x)
f(x) = (∇⋅u_exact)(x)</code></pre> <p>For convenience, we define a function <code>solve_darcy</code> which performs some of the steps of the finite element simulation pipeline &#40;namely finite element spaces setup, assembly and solution of linear system&#41;. We will later re-use this function at at each mesh of the AMR hierarchy:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> solve_darcy(model,order)
  V = FESpace(model,
              ReferenceFE(raviart_thomas,<span class=hljs-built_in >Float64</span>,order),
              conformity=:Hdiv)

  Q = FESpace(model,
              ReferenceFE(lagrangian,<span class=hljs-built_in >Float64</span>,order);
              conformity=:L2)

  U = TrialFESpace(V,u_exact)
  P = TrialFESpace(Q)

  Y = MultiFieldFESpace([V, Q])
  X = MultiFieldFESpace([U, P])

  trian = Triangulation(model)
  degree = <span class=hljs-number >2</span>*(order+<span class=hljs-number >1</span>)
  dΩ = Measure(trian,degree)

  Γ = BoundaryTriangulation(model)
  dΓ = Measure(Γ,degree)
  nΓ = get_normal_vector(Γ)

  a((u, p),(v, q)) = ∫(u⋅v)dΩ +∫(q*(∇⋅u))dΩ-∫((∇⋅v)*p)dΩ
  b((v, q)) = ∫(q*f)dΩ-∫((v⋅nΓ)*p_exact )dΓ

  op = AffineFEOperator(a,b,X,Y)
  xh = solve(op)
  xh, num_free_dofs(Y)
<span class=hljs-keyword >end</span></code></pre> <p>At this point you should be already familiar with the steps in the <code>solve_darcy</code> function. It worths noting that we create <code>V</code>, i.e., the finite element space for the fluid velocity, such that it is div-conforming. To this end, as mentioned above, we use the <code>raviart_thomas</code> finite element, and specify the <code>conformity</code> of the space to be <code>:Hdiv</code>.</p> <p>For convenience, we also define a function to compute the errors among the finite element solution and the exact solution. We will be also using the function at each level of the AMR hierarchy.</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> compute_error_darcy(model,degree,xh)
  Ω = Triangulation(model)
  degree = <span class=hljs-number >4</span>*(order+<span class=hljs-number >1</span>)
  dΩ = Measure(Ω,degree)

  Γ = BoundaryTriangulation(model)
  degree = <span class=hljs-number >2</span>*(order+<span class=hljs-number >1</span>)
  dΓ = Measure(Γ,degree)
  nΓ = get_normal_vector(Γ)

  uh, ph = xh
  eu = u_exact - uh
  ep = p_exact - ph

  l2_norm(v)   = sqrt(sum(∫(v⋅v)dΩ))
  hdiv_norm(v) = sqrt(sum(∫(v⋅v + (∇⋅v)*(∇⋅v))dΩ))

  l2_norm(eu), hdiv_norm(eu), l2_norm(ep)
<span class=hljs-keyword >end</span></code></pre> <p>For visualization purposes, we define a function which, given a distributed discrete model, returns a distributed cell array which contains the parallel task identifier that owns each cell. If we visualize such array in ParaView, we will be able to observe how the mesh has been partitioned among parallel tasks</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> get_cell_to_parallel_task(model)
  model_partition_descriptor=partition(get_cell_gids(model))
  map(model_partition_descriptor) <span class=hljs-keyword >do</span> indices
    own_to_owner(indices)
  <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre> <p>The next step is to create the coarse mesh <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >C</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{C}_h</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. As <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span> is just the unit square in our particular case, a <code>CartesianDiscreteModel</code> with a single cell is sufficient to resolve the geometry of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ω</mi></mrow><annotation encoding="application/x-tex">\Omega</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ω</span></span></span></span>:</p> <pre><code class="julia hljs">coarse_model=CartesianDiscreteModel((<span class=hljs-number >0</span>,<span class=hljs-number >1</span>,<span class=hljs-number >0</span>,<span class=hljs-number >1</span>),(<span class=hljs-number >1</span>,<span class=hljs-number >1</span>))</code></pre>
<p>We stress, however, that we may import as well a coarse mesh generated from an unstructured mesh generator, e.g., using <code>GridapGmsh</code>, as we have done in other tutorials.</p>
<p>As with any parallel distributed memory code in the Gridap ecosystem, we have to create our distributed rank indices. Using the <code>MPI</code> julia package, we can query for the number of MPI tasks with which we spawned the parallel program. In particular, the <code>MPI.Comm_size</code> function provides such functionality.</p>
<pre><code class="julia hljs">MPI.Init()
nprocs = MPI.Comm_size(MPI.COMM_WORLD)
ranks  = with_mpi() <span class=hljs-keyword >do</span> distribute
  distribute(<span class=hljs-built_in >LinearIndices</span>((prod(nprocs),)))
<span class=hljs-keyword >end</span></code></pre>
<p>Once we have created the coarse mesh and the <code>rank</code> indices, we are ready to create the forest-of-quadtrees <code>DiscreteModel</code>. We do it by specifying how many steps of uniform refinement steps we want to apply to the coarse mesh. We note that the resulting mesh is already distributed/partitioned among the parallel tasks:</p>
<pre><code class="julia hljs">num_uniform_refinement_steps=<span class=hljs-number >4</span>
model=OctreeDistributedDiscreteModel(ranks,coarse_model,num_uniform_refinement_steps)</code></pre>
<p>Once we have created an inital forest-of-quadtrees, we will dynamically build a hierarchy of successively adapted meshes by exploiting the knowledge of the approximate solution computed at each level. This iterative process, which we will refer to as AMR loop, can be summarized as follows:</p>
<ol>
<li><p>Compute an approximate finite element solution <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><msub><mi>u</mi><mi>h</mi></msub><mo separator=true >,</mo><msub><mi>p</mi><mi>h</mi></msub><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(u_h,p_h)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span> for the Darcy problem using the current mesh.</p>

<li><p>Compute <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">e_K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for all cells <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> in the mesh using <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><msub><mi>u</mi><mi>h</mi></msub><mo separator=true >,</mo><msub><mi>p</mi><mi>h</mi></msub><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(u_h,p_h)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span>. In general, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">e_K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is an error indicator such as, e.g., an a-posteriori error estimator &#91;4&#93; at that cell. In this particular tutorial, as we know the true solution <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{\rm exact}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal">p</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>,  we will use the true error norm <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub><mo>=</mo><mi mathvariant=normal >∣</mi><mi mathvariant=normal >∣</mi><msub><mi>u</mi><mi>h</mi></msub><mo>−</mo><msub><mi>u</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >x</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >t</mi></mrow></msub><mi mathvariant=normal >∣</mi><msub><mi mathvariant=normal >∣</mi><mrow><msup><mi>L</mi><mn>2</mn></msup><mo stretchy=false >(</mo><mi>K</mi><mo stretchy=false >)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">e_K=||u_h-u_{\rm exact}||_{L^2(K)}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >∣</span><span class=mord >∣</span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">x</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">t</span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mord ><span class=mord >∣</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span> instead.</p>

<li><p>Given user-defined refinement and coarsening fractions, denoted by <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, resp., find thresholds <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\theta_r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\theta_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> such that the number of cells with <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub><mo>&gt;</mo><msub><mi>θ</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">e_K &gt;\theta_r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6891em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >&gt;</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>  &#40;resp., <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub><mo>&lt;</mo><msub><mi>θ</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">e_K &lt; \theta_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6891em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >&lt;</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>&#41;  is &#40;approximately&#41; a fraction <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>  &#40;resp., <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>&#41; of the number of cells in the mesh.</p>

<li><p>Refine and coarsen the mesh cells, i.e., generate a new mesh,  accordingly to the input provided by the previous step.</p>

<li><p>&#40;Optionally&#41; Dynamically balance load among the parallel tasks.</p>

<li><p>Repeat steps 1.-5. a number of user-defined steps.</p>

</ol>
<p>This algorithm is encompassed in the <code>amr_loop</code> function below:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> amr_loop(model, order, num_amr_steps, αr, αc;
                  generate_vtk_files=<span class=hljs-literal >true</span>, redistribute_load=<span class=hljs-literal >true</span>)

  adaptive_strategy=
      FixedFractionAdaptiveFlagsMarkingStrategy(αr, αc)

  ndofs_x_level=<span class=hljs-built_in >Int</span>[]
  l2eu_x_level=<span class=hljs-built_in >Float64</span>[]
  hdiveu_x_level=<span class=hljs-built_in >Float64</span>[]
  l2pe_x_level=<span class=hljs-built_in >Float64</span>[]

  <span class=hljs-keyword >for</span> amr_step=<span class=hljs-number >0</span>:num_amr_steps
    <span class=hljs-comment ># Solve the finite element problem in the current mesh</span>
    xh,ndofs=solve_darcy(model,order)

    <span class=hljs-keyword >if</span> (generate_vtk_files)
       uh,ph = xh
       writevtk(Triangulation(model),
                <span class=hljs-string >&quot;results_amr_order=<span class=hljs-subst >$(order)</span>_step_<span class=hljs-subst >$(amr_step)</span>&quot;</span>,
                cellfields=[<span class=hljs-string >&quot;uh&quot;</span>=&gt;uh,
                            <span class=hljs-string >&quot;ph&quot;</span>=&gt;ph,
                            <span class=hljs-string >&quot;euh&quot;</span>=&gt;u_exact-uh,
                            <span class=hljs-string >&quot;eph&quot;</span>=&gt;p_exact-ph,
                            <span class=hljs-string >&quot;partition&quot;</span>=&gt;get_cell_to_parallel_task(model)])
    <span class=hljs-keyword >end</span>

    <span class=hljs-comment ># Compute error among finite element solution and exact solution</span>
    l2eu,hdiveu,l2ep=compute_error_darcy(model,<span class=hljs-number >2</span>*order+<span class=hljs-number >1</span>,xh)
    append!(l2eu_x_level,l2eu)
    append!(hdiveu_x_level,hdiveu)
    append!(l2pe_x_level,l2ep)
    append!(ndofs_x_level,ndofs)

    <span class=hljs-comment ># Compute error indicators e_K</span>
    uh,ph = xh
    euh = u_exact-uh
    eph = p_exact-ph
    Ω = Triangulation(model)
    dΩ = Measure(Ω,<span class=hljs-number >2</span>*order+<span class=hljs-number >1</span>)
    e_K = map(dc -&gt; sqrt.(get_array(dc)), local_views(∫(euh⋅euh)dΩ))

    <span class=hljs-comment ># Get object which describes how the mesh is partitioned/distributed among parallel tasks</span>
    model_partition_descriptor=partition(get_cell_gids(model))

    <span class=hljs-comment ># Create/initialize adaptivity flags</span>
    ref_coarse_flags = map(model_partition_descriptor) <span class=hljs-keyword >do</span> indices
      flags = <span class=hljs-built_in >Vector</span>{<span class=hljs-built_in >Int64</span>}(<span class=hljs-literal >undef</span>, length(indices))
      flags .= nothing_flag
    <span class=hljs-keyword >end</span>

    <span class=hljs-comment ># Determine which cells are marked for refinement/coarsening</span>
    update_adaptivity_flags!(ref_coarse_flags,
                             adaptive_strategy,
                             model_partition_descriptor,
                             e_K)

    <span class=hljs-comment ># Adapt the model given the adaptivity flags</span>
    model,_= adapt(model, ref_coarse_flags)

    <span class=hljs-keyword >if</span> (amr_step != num_amr_steps &amp;&amp; redistribute_load)
      <span class=hljs-comment ># Dynamically redistribute the model among parallel tasks</span>
      model,_= redistribute(model)
    <span class=hljs-keyword >end</span>
  <span class=hljs-keyword >end</span>
  model,ndofs_x_level,l2eu_x_level,hdiveu_x_level,l2pe_x_level
<span class=hljs-keyword >end</span></code></pre>
<p>The <code>amr_loop</code> function re-uses the previously defined functions along with functionality available in <code>GridapP4est.jl</code> to implement the 6 steps enumerated above. The <code>FixedFractionAdaptiveFlagsMarkingStrategy</code> constructor creates a Julia object which conceptually represents the strategy in step 3. Combining this object with the cell-wise error indicators <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">e_K</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, the <code>update_adaptivity_flags&#33;</code> function determines which cells to be refined, which to coarsen, and which to leave as they were prior to adaptation &#40;as per described in step 3.&#41;. Finally, the <code>adapt</code> function adapts the mesh using the flags, and the <code>redistribute</code> function dynamically balances the load among the MPI tasks to correct for the imbalances caused by mesh adaptation.</p>
<p>It is worth noting that both the <code>adapt</code> and <code>redistribute</code> functions return a second object apart from the transformed discrete model. These objects are referenced by a place holder variable named <code>_</code> which is not further used in the function. We note, however, that these objects encode relevant information that allows one to describe how the original and the transformed models are related. This is particularly necessary when dealing with transient and/or non-linear problems, where one has to transfer data &#40;e.g., finite element functions&#41; among meshes. For simplicity, this feature is not illustrated in the tutorial.</p>
<p>We then call the <code>amr_loop</code> function with <code>αr&#61;0.1</code> and <code>αc&#61;0.05</code> meaning that approximately 15&#37; and 5&#37; of the cells will approximately be refined and coarsened, respectively, at each adaptation step.</p>
<pre><code class="julia hljs">order=<span class=hljs-number >1</span>
αr=<span class=hljs-number >0.10</span>
αc=<span class=hljs-number >0.05</span>
num_amr_steps=<span class=hljs-number >10</span>
final_model,ndofss,l2ues,hdivues,l2pes=amr_loop(model, order, num_amr_steps, αr, αc;
                                                generate_vtk_files=<span class=hljs-literal >true</span>, redistribute_load=<span class=hljs-literal >true</span>)</code></pre>
<p>After execution, the function generates data visualization files plus the L2 and Hdiv errors of the discrete fluid flow and the L2 error of the discrete fluid velocity at each AMR level. At this point, we encourage the reader to open these files in ParaView and observe that, as expected, there is a clear tendency of the algorithm to adapt the mesh in the region where the circular wave front is located. The reader may also want to observe how the partition of the mesh among cells varies among levels in order to correct for the parallel load imbalances caused by mesh adaptation.</p>
<p>As usual, it is helpful to visualize how errors decay with the number of degrees of freedom as the mesh is adapted across several adaptation cycles. The following code generates a plot and writes it into a PDF file in the parallel task with identifier 0.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >if</span> (MPI.Comm_rank(MPI.COMM_WORLD)==<span class=hljs-number >0</span>)
  <span class=hljs-keyword >using</span> Plots
  plt = plot(xlabel=<span class=hljs-string >&quot;ndofs&quot;</span>,ylabel=<span class=hljs-string >&quot;L2 error (fluid velocity)&quot;</span>,grid=<span class=hljs-literal >true</span>)
  plot!(plt,title=<span class=hljs-string >&quot;γ=<span class=hljs-subst >$(γ)</span>, r=<span class=hljs-subst >$(r)</span>, center=<span class=hljs-subst >$(xc)</span>&quot;</span>, yaxis=:log10, xaxis=:log10, linewidth=<span class=hljs-number >3</span>)
  plot!(plt,ndofss,l2ues,label=<span class=hljs-string >&quot;order=<span class=hljs-subst >$(order)</span> AMR&quot;</span>,markershape=:s,markersize=<span class=hljs-number >6</span>)
  savefig(plt, <span class=hljs-string >&quot;amr_error_decay_l2eu_order=<span class=hljs-subst >$(order)</span>.pdf&quot;</span> )
<span class=hljs-keyword >end</span></code></pre>
<h2 id=homework ><a href="#homework" class=header-anchor >Homework</a></h2>
<ul>
<li><p>Deactivate <code>redistributed_load</code> in the <code>amr_loop</code> function call. Then, observe in ParaView the load distribution among parallel tasks, and compare it against the one in which the load is re-balanced at each step.</p>

<li><p>Extend the code such that it compares error decay between uniform refinement and AMR.</p>

<li><p>Study error decay of <code>order&#61;0</code> versus <code>order&#61;1</code>.</p>

<li><p>Study error decay and refinement patters for different values of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_r</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_c</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>

<li><p>Extend the present tutorial to 3D.</p>

</ul>
<h2 id=references ><a href="#references" class=header-anchor >References</a></h2>
<p>&#91;1&#93; F. Brezzi and M. Fortin. <em>Mixed and hybrid finite element methods</em>. Springer-Verlag, 1991.</p>
<p>&#91;2&#93; C. Burstedde, L. C. Wilcox, O. Ghattas. <em>p4est: Scalable Algorithms for Parallel Adaptive Mesh Refinement on Forests of Octrees</em>. SIAM Journal on Scientific Computing 33 &#40;3&#41; &#40;2011&#41;.</p>
<p>&#91;3&#93; S. Badia, A. F. Martin, E. Neiva, and F. Verdugo. <em>A Generic Finite Element Framework on Parallel Tree-Based Adaptive Meshes</em>. SIAM Journal on Scientific Computing 46 &#40;2&#41; &#40;2020&#41;.</p>
<p>&#91;4&#93; M. Ainsworth, J. T. Oden. <em>A Posteriori Error Estimation in Finite Element Analysis.</em>. John Wiley &amp; Sons, 2000.</p>

<div class=page-foot >
  <div class=copyright >
    <a href="https://github.com/gridap/GridapWorkshopNCI2023"><b>Edit this page on <img class=github-logo  src="https://unpkg.com/ionicons@5.1.2/dist/svg/logo-github.svg"></b></a><br>
    Last modified: November 25, 2023. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>